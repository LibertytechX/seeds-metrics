.PHONY: help build run test clean docker-build docker-up docker-down docker-logs db-migrate db-reset

# Default target
help:
	@echo "Available commands:"
	@echo "  make build        - Build the Go binary"
	@echo "  make run          - Run the application locally"
	@echo "  make test         - Run tests"
	@echo "  make clean        - Clean build artifacts"
	@echo "  make docker-build - Build Docker image"
	@echo "  make docker-up    - Start all Docker services"
	@echo "  make docker-down  - Stop all Docker services"
	@echo "  make docker-logs  - View Docker logs"
	@echo "  make db-migrate   - Run database migrations"
	@echo "  make db-reset     - Reset database (âš ï¸  deletes all data)"

# Build the Go binary
build:
	@echo "ğŸ”¨ Building Go binary..."
	go build -o bin/analytics-api cmd/api/main.go
	@echo "âœ… Build complete: bin/analytics-api"

# Run the application locally
run:
	@echo "ğŸš€ Starting application..."
	go run cmd/api/main.go

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	@echo "âœ… Clean complete"

# Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker-compose build
	@echo "âœ… Docker image built"

# Start all Docker services
docker-up:
	@echo "ğŸš€ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started"
	@echo ""
	@echo "ğŸ“¡ API: http://localhost:8080"
	@echo "ğŸ—„ï¸  PostgreSQL: localhost:5432"
	@echo "ğŸ”´ Redis: localhost:6379"
	@echo ""
	@echo "Run 'make docker-logs' to view logs"

# Stop all Docker services
docker-down:
	@echo "ğŸ›‘ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped"

# View Docker logs
docker-logs:
	docker-compose logs -f

# Run database migrations
db-migrate:
	@echo "ğŸ“Š Running database migrations..."
	docker exec -it analytics-postgres psql -U analytics_user -d analytics_db -f /docker-entrypoint-initdb.d/001_initial_schema.sql
	@echo "âœ… Migrations complete"

# Reset database (âš ï¸ deletes all data)
db-reset:
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down -v; \
		docker-compose up -d postgres; \
		sleep 5; \
		make db-migrate; \
		echo "âœ… Database reset complete"; \
	else \
		echo "âŒ Cancelled"; \
	fi

# Install Go dependencies
deps:
	@echo "ğŸ“¦ Installing Go dependencies..."
	go mod download
	@echo "âœ… Dependencies installed"

# Format code
fmt:
	@echo "ğŸ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Code formatted"

# Lint code
lint:
	@echo "ğŸ” Linting code..."
	golangci-lint run
	@echo "âœ… Linting complete"

# Create .env file from example
env:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Created .env file from .env.example"; \
	else \
		echo "âš ï¸  .env file already exists"; \
	fi

